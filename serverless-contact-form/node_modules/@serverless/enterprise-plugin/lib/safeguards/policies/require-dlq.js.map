{"version":3,"sources":["../../../../lib/safeguards/policies/require-dlq.js"],"names":["require","entries","fromPairs","asyncEvents","Set","module","exports","dlqPolicy","policy","service","failed","functions","declaration","naming","provider","Resources","compiled","logicalFuncNamesToConfigFuncName","Object","keys","map","funcName","getLambdaLogicalId","Properties","Type","DeadLetterConfig","TargetArn","events","eventTypes","ev","eventIntersection","filter","x","has","length","size","fail","approve","docs"],"mappings":"AAAA;;;;;;;;;;iBAE+BA,OAAO,CAAC,QAAD,C;MAA9BC,O,YAAAA,O;MAASC,S,YAAAA,S;;AAEjB,MAAMC,WAAW,GAAG,IAAIC,GAAJ,CAAQ,CAC1B,IAD0B,EAE1B,KAF0B,EAG1B,YAH0B,EAI1B,KAJ0B,EAK1B,iBAL0B,EAM1B,eAN0B,EAO1B,iBAP0B,EAQ1B,gBAR0B,CAAR,CAApB;;AAUAC,MAAM,CAACC,OAAP,GAAiB,SAASC,SAAT,CAAmBC,MAAnB,EAA2BC,OAA3B,EAAoC;AACnD,MAAIC,MAAM,GAAG,KAAb;AADmD,QAGlCC,SAHkC,GAQ/CF,OAR+C,CAGjDG,WAHiD,CAGlCD,SAHkC;AAAA,QAIrCE,MAJqC,GAQ/CJ,OAR+C,CAIjDK,QAJiD,CAIrCD,MAJqC;AAAA,QAMAE,SANA,GAQ/CN,OAR+C,CAKjDO,QALiD,CAM/C,2CAN+C,EAMAD,SANA;AASnD,QAAME,gCAAgC,GAAGf,SAAS,CAChDgB,MAAM,CAACC,IAAP,CAAYR,SAAS,IAAI,EAAzB,EAA6BS,GAA7B,CAAiCC,QAAQ,IAAI,CAACR,MAAM,CAACS,kBAAP,CAA0BD,QAA1B,CAAD,EAAsCA,QAAtC,CAA7C,CADgD,CAAlD,CATmD,CAanD;;AAbmD;AAAA;AAAA;;AAAA;AAcnD,yBAA+CpB,OAAO,CAACc,SAAD,CAAtD,8HAAmE;AAAA;AAAA,YAAvDM,QAAuD;AAAA;AAAA,YAA3CE,UAA2C,gBAA3CA,UAA2C;AAAA,YAA/BC,IAA+B,gBAA/BA,IAA+B;;AACjE,UACEA,IAAI,KAAK,uBAAT,IACCD,UAAU,CAACE,gBAAX,IAA+BF,UAAU,CAACE,gBAAX,CAA4BC,SAF9D,EAGE;AACA;AACD;;AACD,YAAMC,MAAM,GAAG,CAAChB,SAAS,CAACM,gCAAgC,CAACI,QAAD,CAAjC,CAAT,IAAyD,EAA1D,EAA8DM,MAA9D,IAAwE,EAAvF;AACA,YAAMC,UAAU,GAAG,IAAIxB,GAAJ,CAAQuB,MAAM,CAACP,GAAP,CAAWS,EAAE,IAAIX,MAAM,CAACC,IAAP,CAAYU,EAAZ,EAAgB,CAAhB,CAAjB,CAAR,CAAnB;AACA,YAAMC,iBAAiB,GAAG,IAAI1B,GAAJ,CAAQ,CAAC,GAAGD,WAAJ,EAAiB4B,MAAjB,CAAwBC,CAAC,IAAIJ,UAAU,CAACK,GAAX,CAAeD,CAAf,CAA7B,CAAR,CAA1B;;AACA,UAAIL,MAAM,CAACO,MAAP,KAAkB,CAAlB,IAAuBJ,iBAAiB,CAACK,IAAlB,GAAyB,CAApD,EAAuD;AACrDzB,QAAAA,MAAM,GAAG,IAAT;AACAF,QAAAA,MAAM,CAAC4B,IAAP,CACG,aAAYnB,gCAAgC,CAACI,QAAD,CAAhC,IACXA,QAAS,gDAFb;AAID;AACF;AA/BkD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAiCnD,MAAI,CAACX,MAAL,EAAa;AACXF,IAAAA,MAAM,CAAC6B,OAAP;AACD;AACF,CApCD;;AAsCAhC,MAAM,CAACC,OAAP,CAAegC,IAAf,GAAsB,+BAAtB","sourcesContent":["'use strict';\n\nconst { entries, fromPairs } = require('lodash');\n\nconst asyncEvents = new Set([\n  's3',\n  'sns',\n  'alexaSkill',\n  'iot',\n  'cloudwatchEvent',\n  'cloudwatchLog',\n  'cognitoUserPool',\n  'alexaSmartHome',\n]);\nmodule.exports = function dlqPolicy(policy, service) {\n  let failed = false;\n  const {\n    declaration: { functions },\n    provider: { naming },\n    compiled: {\n      'cloudformation-template-update-stack.json': { Resources },\n    },\n  } = service;\n  const logicalFuncNamesToConfigFuncName = fromPairs(\n    Object.keys(functions || {}).map(funcName => [naming.getLambdaLogicalId(funcName), funcName])\n  );\n\n  // for (const [name, { events, onError }] of entries(functions)) {\n  for (const [funcName, { Properties, Type }] of entries(Resources)) {\n    if (\n      Type !== 'AWS::Lambda::Function' ||\n      (Properties.DeadLetterConfig && Properties.DeadLetterConfig.TargetArn)\n    ) {\n      continue;\n    }\n    const events = (functions[logicalFuncNamesToConfigFuncName[funcName]] || {}).events || [];\n    const eventTypes = new Set(events.map(ev => Object.keys(ev)[0]));\n    const eventIntersection = new Set([...asyncEvents].filter(x => eventTypes.has(x)));\n    if (events.length === 0 || eventIntersection.size > 0) {\n      failed = true;\n      policy.fail(\n        `Function \"${logicalFuncNamesToConfigFuncName[funcName] ||\n          funcName}\" doesn't have a Dead Letter Queue configured.`\n      );\n    }\n  }\n\n  if (!failed) {\n    policy.approve();\n  }\n};\n\nmodule.exports.docs = 'http://slss.io/sg-require-dlq';\n"],"file":"require-dlq.js"}